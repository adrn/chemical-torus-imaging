% To-dos
% ------

\documentclass[modern]{aastex63}

\input{preamble.tex}

% text macros
% \newcommand{\methodname}{Tag Moment Roulette}
\newcommand{\methodname}{Action--Tag Modeling}
\newcommand{\method}{\acronym{TMR}}

% Project macros - all others go in preamble.tex
\newcommand{\gaia}{\textsl{Gaia}}
\newcommand{\dr}[1]{\acronym{DR}#1}
\newcommand{\apogee}{\acronym{APOGEE}}
\newcommand{\sdss}{\acronym{SDSS}}
\newcommand{\sdssiv}{\acronym{SDSS-IV}}
\newcommand{\sdssv}{\acronym{SDSS-V}}
\newcommand{\galah}{\acronym{GALAH}}
\newcommand{\hermes}{\acronym{HERMES}}

\setlength{\parindent}{1.1\baselineskip} % trust in Hogg
\shorttitle{tags are separable from angles}
\shortauthors{apw, dwh, hwr, and more}

\begin{document}\sloppy\sloppypar\raggedbottom\frenchspacing % trust in Hogg
\graphicspath{ {figures/} }
\DeclareGraphicsExtensions{.pdf,.eps,.png}

\title{\textbf{%
\methodname:\\
Identifying orbits in phase space through invariances\\
of element-abundance distributions}}

\author[0000-0003-0872-7098]{Adrian~M.~Price-Whelan}
\affil{Flatiron Institute, 162 Fifth Ave, New York, NY 10010, USA}

\author[0000-0003-2866-9403]{David W. Hogg}
\affil{Flatiron Institute, 162 Fifth Ave, New York, NY 10010, USA}
\affil{Max-Planck-Institut f\"ur Astronomie, K\"onigstuhl 17, D-69117 Heidelberg}
\affil{Center for Cosmology and Particle Physics, Department of Physics, New York University, 726 Broadway, New York, NY 10003, USA}
% \affil{Center for Data Science, New York University, 60 Fifth Ave, New York, NY 10011, USA}

\author[0000-0003-4996-9069]{Hans-Walter Rix}
\affil{Max-Planck-Institut f\"ur Astronomie, K\"onigstuhl 17, D-69117 Heidelberg}

\author{Others}

\begin{abstract}\noindent % Hogg strikes again
  The dynamics of the Milky Way---and nearby galaxies---are often
  understood in an approximation in which the gravitational potential
  is treated as simple and integrable and the distribution function
  time-invariant.
  Under these conditions, the Jeans equations are relevant and Jeans
  modeling is the standard---though not the only---methodology.
  Here we present an alternative approach for inference, which makes
  use of the fact that there are generically gradients, or dependences
  of element abundnaces and stellar ages (and other invariant stellar
  tags) on position in the Galaxy.
  The method exploits the fact that in an integrable, steady-state
  gravitational system, the distribution of any invariant stellar tags
  must be invariant with respect to time-variable conjugate angles.
  As a demonstration of the concepts and methods, we use
  \apogee\ giant stars to look at vertical orbit structure in Milky
  Way disk.
  We show that the disk mass can be constrained na\"ively at the
  XXX-percent level with \methodname.
  We write down and discuss both frequentist-statistics and Bayesian
  forward-modeling approaches to inference.
  \methodname\ has great advantages:
  It does not depend on making measurements of second (or higher)
  moments of the velocity distribution, as Jeans modeling
  requires.
  It does not depend on potential separability, although it does require
  integrability.
  It can be written in a form that is, to first order, independent
  of the details of the stellar selection function.
  It requires, however, abundance (or other) gradients with respect to actions.
  Fortunately, God provides.
\end{abstract}

% \keywords{\raggedright
%  astrometry
%  ---
%  Galaxy:~disk
%  ---
%  Galaxy:~fundamental~parameters
%  ---
%  Galaxy:~kinematics~and~dynamics
%  ---
%  methods:~data~analysis
%  ---
%  stars:~abundances
%  ---
%  stars:~kinematics~and~dynamics
% }

\section*{}\clearpage

\section{Introduction}

In a well-mixed population, stars are in a kinematic steady state:
As time goes on, stars move along their orbits, but they don't change their dynamical
invariants (by assumption!) and every location in angle (and by ``angle'' we mean the
coordinate conjugate to action in action--angle coordinates) is equally likely, or
equally probably populated in any snapshot.
The chemical-tagging insight is that the stars also don't change their surface element
abundances as they orbit.
That is, in a well-mixed galaxy, the element abundances and the dynamical actions have
something in common:
They don't change with time, while the conjugate angles do.
This means that, for a well-mixed population, the detailed element abundances can only
be a function of actions, and never a function of conjugate angles.
That's a remarkably informative constraint on the configuration of the Milky Way in
the space of positions (3), velocities (3), and detailed abundances (10 to 30, depending
on survey).

Consider a collection of stars (localized, say, in phase space) for which we have
measured $D$ element abundances.
This collection of stars is drawn from some density or distribution in
the $D$-dimensional element-abundance space.
Now consider how this distribution varies as we move around in phase space.
It will vary in general (there are radial and vertical abundance gradients in the
disk, for example).
Any gradient we observe in these element-abundance distributions with respect to
phase-space coordinates (that is, the six-gradient) must not project
onto the directions of increasing (or decreasing) conjugate angles in phase space.
That is, all gradients with respect to phase-space coordinates
of the element-abundance distribution must be orthogonal to the
directions of increase (or decrease) of the conjugate angles, and lie in the subspace
of the directions of increase (or decrease) of the dynamical actions.
The trajectories of stars in the phase space (the dynamical tori) must lie along or
describe level surfaces in the element-abundance distribution!

One of the crazy things about all this is that any description of a general distribution in $D$-space
requires a \emph{lot of parameters}.
Even a trivial distribution---the Normal distribution---requires $0.5\,D\,(D+3)$ parameters for its
complete description, and anything more complex has more.
That means that there are a very large set of element-abundance statistics for which the
six-gradient exists or could be constraining for this project.
Not all of these parameters can be reliably measured in a finite data set,
let alone reliably seen to vary with phase-space location.
However, we choose to see this bug as a feature:
We have discovered, in effect, a \emph{combinatorically large set of constraints on the
dynamical actions and conjugate angles}.

HERE WE JUST CONSIDER VERTICAL DYNAMICS.
This restricts the problem usefully and is good for pedagogical purposes.
But obviously it is not unlocking the full promise of this family of methods.

BUT WE ARE NOT GOING TO ASSUME SEPARABILITY.
Jeans models can suck it.

HOGG Aside: Controversy over the massive/dense disk. How we might resolve it.
But still making the phase-mixed assumption! Note the Antoja results and the \gaia\ results
that suggest that the disk is not well mixed, even locally.

\section{Methodological generalities}

HOGG ASKS: IS THIS WRITTEN TOO PEDAGOGICALLY?

This project was motivated by plots of abundances of stars as a
function of vertical height $z$ and vertical velocity $v_z$ in
Galactocentric cylindrical coordinates, colored by element abundances.
Examples are shown in \figurename~APW.
In these plots,
the eye is drawn to \emph{abundance gradients}: The stars at small
heights and small vertical velocities have different abundance ratios,
on average, than stars at large heights and large vertical velocities.
But these positional and velocity gradients are related:
Stars at large absolute vertical velocities $v_z$ will, in the future, at some
times be at large absolute vertical positions $z$ (far from the plane, that is),
and stars at large absolute vertical positions will, in the future,
at some times be at large absolute vertical velocities.
That is, the stars will orbit in the Galaxy.
And stars don't---to very high precision---change their abundances as
they orbit.

One consequence of these observations is a new method for inferring
the orbit structure of the Milky Way:
If two small neighborhoods in phase space lie on the same orbit---that
is, they correspond to the same dynamical actions or they can be reached
by common initial conditions---they must contain stars with the same distribution of
element abundances.
This prediction depends on many detailed assumptions, such as that
the Galaxy is (approximately) phase mixed, and that the potential is
(approximately) time invariant and integrable.
The usefulness of this prediction for inference
depends on the existence of gradients: If there aren't
element-abundance-ratio gradients, there will be no information to work
with.

In more mathematical language: The orbits (which are 3-tori in
6-dimensional phase space) in a steady-state, integrable, phase-mixed
galaxy will be level hyper-surfaces in phase space of any moments or
statistics of the element-abundance distribution... HOGG

This point is illustrated graphically in \figurename~XXX:
In the fiducial model, the two overlaid orbits more-or-less follow something
like a mean abundance contour.
In the model in which the disk is made less massive (and the halo more massive
to keep the circular velocity constant), the orbits change shape: There is more
positional extent to an orbit relative to it's velocity extent.
The orbital frequency $\omega$ is, to order of magnitude, the velocity amplitude
divided by the spatial amplitude, and it is, to order of magnitude, $\sqrt{G\,\rho}$,
where $\rho$ is the mean enclosed mass density.
If stars were traveling on these lower-disk-mass orbits, they would have to
obtain higher abundances when they are passing through the disk midplane,
and lower abundances when they are at their greatest absolute vertical heights,
which is absurd: Stars do not change their abundances as they orbit.

We make this point clear in a different way in \figurename~YYY, in which
we have transformed into action--angle coordinates in phase space (CITE)
and we show scatterplots of the abundances as a function of conjugate
angles $\theta_z$, conjugate to the vertical actions $J_z$, for stars near
the orbits plotted in \figurename~XXX.
Using the fiducial potential to convert to actions and angles,
the abundance distribution is similar at different
angles $\theta_z$, or on different parts of the orbit.
Along the orbits generated by the low-mass-disk and high-mass-disk potentials,
the abundance distribution shows clear $m=2$ (or $\exp i\,2\,\theta_z$) dependences
on vertical angle $\theta_z$.
That is, just by plotting the abundances versus angle, we can make
inferences about the mass of the disk, or---more generally---the
gravitational potential of the Milky Way.

...The point that this works at one to three dimensions. It requires abundance gradients, but not separability!
Of course you might not have abundance gradients in all three action directions.

...The point that the method is combinatoric in data.

...The point that this would be more complex in chaotic regions, and maybe effectively
inapplicable?

...The point that this doesn't depend on selection, provided that stellar properties don't vary strongly with abundnaces, and that abundance-measurement biases don't depend strongly on stellar parameters. Both assumptions wrong in detail.

... The point that there will be frequentist statistics or optimizations, and also Bayesian approaches.
The point that Bayes and frequentism look very different here. Call out to orbital
roulette, and to Bovy et al.

In what follows, a very limited project...

\section{Data}

% For this project we make use of \galah\ Survey (\citealt{galah, galah2}) data taken
% with the \hermes\ instrument (\citealt{hermes10, hermes15}).
% \galah\ has released in its second data release (\citealt{galahdr2})
% XXX measurements of element abundances for YYY stars.
% These stars have good representation near the Sun, so the sample is ideally suited for studying
% the Solar Neighborhood and the nearby disk.

% In detail, we subsample the \galah\ data to HOGG WHAT REGION of phase space.
% This leaves HOGG HOW MANY stars.
% The subsample we use is shown in \figurename~\ref{fig:data}.
% \begin{figure}
% \caption{The data used in this \documentname.
% Each panel shows the stellar points in the plane
% of vertical position $z$ and vertical velocity $v_z$,
% colored by a different element abundance ratio.
% These are phase-space plots, but colored by the abundance ratios.
% It is clear in these plots that the abundance ratio level surfaces will be
% constraining on the orbits.\label{fig:data}}
% \end{figure}

% There are many different abundance ratios we might use to constrain the vertical of the disk.
% structure.
% We choose HOGG WHAT RATIOS because they are well measured in \galah\ and they show strong
% vertical gradients.
% These abundance ratios are shown in \figurename~\ref{fig:data}.
% This choice is relatively arbitrary; there is no sense in which this project is making use
% of all the element-abundance information latent in the \galah\ data.

% As we will describe below, the method depends critically on the element abundance
% measurements being consistent across stellar types.
% That is, it is critical that the element abundance measurments in luminous
% stars---which are observed to greater distances in general---are similar in their
% biases to the measurements in less luminous stars.
% That is, the abundance measurements don't necessarily have to be accurate, but
% they do have to be consistent.
% In \figurename~\ref{fig:testing}, HOGG SOMETHING IS SHOWN.
% \begin{figure}
% \caption{HOGG SOME KIND OF TEST that the element abundance measurements
% are consistent for stars of different surface gravities.\label{fig:testing}}
% \end{figure}

% In addition to the \galah\ abundance data, we use radial-velocity measurements from \galah,
% and position and proper-motion measurements from \gaia\ (\citealt{gaia})
% \acronym{DR2} (\citealt{gaiadr2}).
% In detail, we matched \galah\ to \gaia\ HOGG HOW?

% We assemble the \galah\ and \gaia\ information for each star into a Galactic position and
% velocity assuming HOGG WHAT THINGS about the Solar phase-space position in the Galaxy.

\section{Assumptions}

The method and results in this \documentname\ will flow from a specific set of
assumptions.
That is, we are going to make hard (and sometimes controversial) assumptions,
and although the assumptions will be questionable, the claim will be that the
method is correct under the assumptions.
\begin{description}
\item[local disk] HOGG: Dynamics dominated by the disk,
and the disk has no transverse spatial gradients. In detail, the sech law and purely
vertical dynamics.

\item[well mixed] HOGG: All angles equally likely. There is probably also a regular-orbits
assumption here, but it won't enter in this \documentname\ because we are only doing
one-dimensional dynamics. The well-mixed assumption will be violated substantially in the data;
we will discuss this more below.

\item[selection] HOGG: Selection depends on position in the Milky Way, but not
on element abundances. Really it could even depend on velocity! But it can't depend
on abundances. That might be very slightly wrong.

\item[kinematic measurements] HOGG: Very strong assumption that phase space positions
in 6-d are accurate and precise. So precise we don't have to generate them, we can
condition on them!

\item[abundance measurements] HOGG: Assumption that stars in different parts of phase
space get the same abundance measurements. Questionable in certain kinds of samples.
HOGG: Oddly I don't think we need to assume that the chemical measurements have good
(or any) noise estimates. They could be terrible, I think.

\item[broad briors] HOGG: Ignoring essentially all prior information about the disk.

\item[smooth gradients] HOGG: Assumption about how the abundances can depend on action.
Relatedly, the use of action and not log-action or zmax or whatever.
\end{description}

\section{Method}

HOGG: Dropping from 3-d to 1-d. In this case, let's start with 1-d. What about that is simpler?

HOGG: maximize conjugate-angle diversity at fixed element abundances?
Or minimize abundance-ratio diversity at fixed orbit? The latter! Why?

The model is, therefore, that the abundances depend only on the vertical actions.
Briefly, it is that any observed abundance distribution
$p(\abundance{X}{Y}\given J_z,\beta_{X/Y})$ for abundance
$\abundance{X}{Y}$ at any action $J_z$ (and given some parameter settings $\beta_{X/Y}$)
is a normal (Gaussian), with a variance $V$ that
is independent of $J_z$ and a mean $\mu(J_z;\beta_{X/Y})$ that varies smoothly with $J_z$.
In symbols:
\begin{eqnarray}
p(\abundance{X}{Y}_n\given J_{zn},\beta_{X/Y}) &=& N(\abundance{X}{Y}_n\given \mu(J_{zn};\beta_{X/Y}), V_{X/Y})
\quad ,
\end{eqnarray}
where the $n$ is an index over stars, and $\beta_{X/Y}$ is a collection of parameters
relevant to abundance $\abundance{X}{Y}$
that includes
parameters describing the smooth variation of the mean with action, and also includes
the variance parameter $V_{X/Y}$.
This being a probabilistic model for the data, it is a generative model and a likelihood function.

Visual inspection of the data (\figurename~ZZZ) and additional tests we performed
show that the chosen abundance ratio distributions
are smooth functions of the vertical action for any potential;
equivalently, the abundance gradients are smooth with height or velocity.
For this reason, we model the dependence of the mean on the action with a cubic polynomial of
the action.
In detail we subtract the mean action from the actions before fitting the cubic, so that the
cubic fit ``pivots'' around the mean action, not zero action.
This detail is adopted to improve numerical stability but has no other influence on the model
in the end.

HOGG: How we set priors on and marginalize the per-metal LFs...
In the end we don't care about the abundance-related parameters $\beta_{X/Y}$ so we marginalize
them out explicitly, to focus on the dynamical side of the problem.
Since the likelihood is Gaussian and the model is a linear function of polynomials of the actions,
the marginalization over the cubic parameters in $\beta_{X/Y}$ is analytic if we choose
Gaussian priors on these parameters.
We adopt Gaussian priors here, and even take the limit in which they are much wider than
the likelihood.
This leads to an analytic marginalization:
HOGG EQUATION HERE.
The variance parameter $V_{X/Y}$ doesn't have this simple marginalization trick, so we apply a
logarithmic prior (flat in $\ln V_{X/Y}$) and marginalize this out numerically.
HOGG EQUATION HERE WITH LOGSUMEXP.

Now the fully margninalized likelihood for the abundances still depends on the computation
of the actions $J_z$. This is, indeed, the whole point of this project.
So while we have fully marginalized out the abundance parameters $\beta_{X/Y}$, we have
remaining a set of dynamical parameters $\theta$.
The dynamical parameters set the conversion of observed positions and velocities into actions $J_z$
and conjugate angles $\phi_z$.

HOGG: Disk model and action/angle calculation.

HOGG: Priors on the disk parameters.

HOGG: MCMC and posterior on the disk parameters. Or something easier than MCMC?

\section{Experiments and results}

HOGG: MCMC description.

HOGG: MCMC results.
\begin{figure}
\caption{Posterior samples for the model parameters.\label{fig:samples}}
\end{figure}

HOGG: best-fit answers, including visualizations of orbits.
\begin{figure}
\caption{Posterior orbit structure. Same as \figurename~ZZZ but now with
posterior-sensible orbits shown to indicate that the orbits do come close to describing
level surfaces in the phase space.\label{fig:orbits}}
\end{figure}

HOGG: Residuals can be visualized. Residuals vs conjugate angles for various potential modifications.

\begin{figure}
n\caption{Abundances versus conjugate angles, for different mass distributions.
Each panel shows an abundance ratio HOGG vs conjugate angle $\phi_z$, for three different
choices of the mean mass density at the disk midplane, for fixed scale height and midplane
location. Note that when the mass distribution gets very wrong, the stars show strong
dependences of abundance ratio on conjugate angle.\label{fig:density}}
\end{figure}

\begin{figure}
\caption{Same as \figurename~WWW, but varying the scale height. Note that
varying the scale height leads to a higher order variation with angle.\label{fig:scaleheight}}
\end{figure}

\begin{figure}
\caption{Same as \figurename~WWW, but varying the midplane location. Note
that varying the midplane location leads to a lower order variation with angle.\label{fig:midplane}}
\end{figure}

\section{Discussion}

HOGG: What did we find? How do our conclusions differ from those before us?

HOGG: In particular, what can we say about the dark disk etc?

HOGG: How is what we did better than what came before or happens by other methods?

HOGG: What are the limitations of what we did; what did we sacrifice for our benefits?

HOGG: Or we could phrase this as a set of failure modes?

HOGG: Return to the assumptions; do any need more discussion? One that does is the smooth
gradients assumption: If we choose different invariants to use, we get slightly different
answers, because (HOGG presumes) that the functional form for the abundance means fits
better or worse. So these results aren't definitive; we should probably use a more flexible
model for the abundance gradients, like a GP or etc.

HOGG: Another is the good abundances and selection assumptions: Do the abundances affect
the selection, and are the abundance measurements a function of stellar type? Either way,
we will inherit biases.

HOGG: What is the limit of this method as we go forward: Many abundance ratios? Many other
statistics of the abundance distribution? How do things change if the abundances track
each other exactly? Is that a problem? Note that we scale much better than chemical tagging
here.

\acknowledgments
It is a pleasure to thank
  Melissa Ness (Columbia),
  who started the conversation that started this project, many years ago.
We also thank
  Jo Bovy (Toronto),
  Anna-Christina Eilers (MIT),
  David Spergel (Flatiron),
  Eugene Vasiliev (Cambridge),
  and the Dynamics and Astronomical Data groups at the Flatiron Institute
for valuable discussions and input.
DWH was partially supported by HOGG GRANT DETAILS.
AMPW was partially supported by HOGG GRANT DETAILS.
HWR was partially supported by HOGG GRANT DETAILS.
This research was conducted in part at the Aspen Center for Physics,
which is supported by National Science Foundation grant \acronym{PHY-1607611}.

SDSS or whatever SPECTROSCOPY ack?

This work has made use of data from the European Space Agency (\acronym{ESA}) mission
\gaia\ (\url{https://www.cosmos.esa.int/gaia}), processed by the \gaia\ Data
Processing and Analysis Consortium (\acronym{DPAC},
\url{https://www.cosmos.esa.int/web/gaia/dpac/consortium}). Funding for the
\acronym{DPAC}
has been provided by national institutions, in particular the institutions
participating in the \gaia\ Multilateral Agreement.

% \facilities{
% \gaia,
% \galah,
% \hermes
% }

% \software{
% \code{Astropy} \citep{astropy, astropy2},
% \code{corner} \citep{corner},
% \code{emcee} \citep{emcee},
% \code{IPython} \citep{ipython},
% \code{matplotlib} \citep{matplotlib},
% \code{numpy} \citep{numpy},
% \code{pyia} \citep{pyia},
% \code{scipy} \citep{scipy}
% }

\end{document}
